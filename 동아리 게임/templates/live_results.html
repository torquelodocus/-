  <audio id="cheer" src="{{ url_for('static', filename='cheer.mp3') }}"></audio>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹¤ì‹œê°„ ìˆœìœ„</title>
  <style>
  /* bodyì˜ backgroundëŠ” ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì—ì„œ ì²˜ë¦¬ */
  body { font-family: Arial, sans-serif; padding: 20px; position: relative; margin:0; overflow:hidden; }
  table { border-collapse: collapse; width: 100%; max-width: 700px; margin-top: 20px; background: rgba(255,255,255,0.5); border-radius: 16px; }
  th, td { border: 1px solid #999; padding: 8px; text-align: center; background: rgba(255,255,255,0.48); }
  th { background: rgba(238,238,238,0.6); }
    #particleCanvas { position:fixed; top:0; left:0; width: 100vw; pointer-events: none; z-index: 10; }
  </style>
</head>
<body style="background-image: url('{{ url_for('static', filename='bg.jpg') }}'); background-size: contain; background-position: center; background-repeat: no-repeat; background-attachment: fixed; font-family: Arial, sans-serif; padding: 20px; position: relative; margin:0; overflow:hidden;">
  <div id="firstNamePopup" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:100;pointer-events:none;">
    <div id="firstNameText" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:7vw;font-weight:bold;text-shadow:0 0 40px #00bfff,0 0 80px #000;white-space:nowrap;"></div>
  </div>
  <canvas id="particleCanvas"></canvas>

  <div style="display: flex; gap: 40px; align-items: flex-start;">
    <div style="flex:1;">
      <h2>ğŸï¸ìë™ì°¨ ë ˆì´ìŠ¤ ìˆœìœ„</h2>
      <table id="raceTable">
        <tr>
          <th>ìˆœìœ„</th>
          <th>í•™ë²ˆ</th>
          <th>Lap 1 (ì´ˆ)</th>
          <th>Lap 2 (ì´ˆ)</th>
          <th>Lap 3 (ì´ˆ)</th>
          <th>ì´ ì‹œê°„ (ì´ˆ)</th>
        </tr>
      </table>
    </div>
    <div style="flex:1;">
      <h2>âœˆï¸ë¹„í–‰ê¸° ê²Œì„ ì ìˆ˜</h2>
      <table id="planeTable">
        <tr>
          <th>ìˆœìœ„</th>
          <th>í•™ë²ˆ</th>
          <th>ì ìˆ˜</th>
        </tr>
      </table>
    </div>
  </div>

  <script>
    function playCheer() {
      try {
        const audio = document.getElementById('cheer');
        audio.currentTime = 0;
        audio.play();
      } catch(e) {}
    }
    function showFirstName(name) {
      const popup = document.getElementById('firstNamePopup');
      const text = document.getElementById('firstNameText');
      text.textContent = name + ' 1ë“±!';
      popup.style.display = 'block';
      setTimeout(() => { popup.style.display = 'none'; }, 2000);
    }
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');

    // ìº”ë²„ìŠ¤ë¥¼ í™”ë©´ ì „ì²´ í”½ì…€ í¬ê¸°ë¡œ ë§ì¶¤
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let particles = [];

    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `${r},${g},${b}`;
    }

    // í™”ë©´ ì „ì²´ í­ì£½ ìƒì„±
    function createFireworks() {
      const colors = ['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff'];
      for (let i=0; i<200; i++) {
        particles.push({
          x: Math.random()*canvas.width,
          y: Math.random()*canvas.height,
          vx: (Math.random()-0.5)*10,
          vy: (Math.random()-0.5)*10,
          alpha: 1,
          size: Math.random()*8 + 2,
          color: colors[Math.floor(Math.random()*colors.length)]
        });
      }
    }

    function updateParticles() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      particles = particles.filter(p => p.alpha > 0);
      particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.alpha -= 0.005; // ì˜¤ë˜ ì§€ì†
        ctx.fillStyle = `rgba(${hexToRgb(p.color)},${p.alpha})`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, 2*Math.PI);
        ctx.fill();
      });
      requestAnimationFrame(updateParticles);
    }
    updateParticles();

    let prevFirstRace = null;
    let prevFirstPlane = null;

    async function fetchAndRender() {
      try {
        const res = await fetch('/api/results');
        if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
        const data = await res.json();

        // ìë™ì°¨ ê¸°ë¡ (ì¤‘ë³µ í•™ë²ˆì€ ê°€ì¥ ë¹ ë¥¸ ê¸°ë¡ë§Œ ë‚¨ê¹€)
        const raceTable = document.getElementById('raceTable');
        raceTable.querySelectorAll('tr:not(:first-child)').forEach(row => row.remove());
        const raceRecords = {};
        data.filter(item => item.type !== 'plane').forEach(item => {
          // ì´ ì‹œê°„ì´ ë” ë¹ ë¥¸ ê¸°ë¡ë§Œ ë‚¨ê¹€
          if (!raceRecords[item.studentId] || (item.total < raceRecords[item.studentId].total)) {
            raceRecords[item.studentId] = item;
          }
        });
        const raceSorted = Object.values(raceRecords).sort((a, b) => a.total - b.total);
        let raceRank = 1;
        let currentFirstRace = null;
        raceSorted.forEach((item) => {
          if(raceRank === 1) currentFirstRace = item.studentId;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${raceRank === 1 ? "ğŸ† " : ""}${raceRank}</td>
            <td>${item.studentId}</td>
            <td>${item.lap1 ? item.lap1.toFixed(2) : '-'}</td>
            <td>${item.lap2 ? item.lap2.toFixed(2) : '-'}</td>
            <td>${item.lap3 ? item.lap3.toFixed(2) : '-'}</td>
            <td>${item.total ? item.total.toFixed(2) : '-'}</td>
          `;
          raceTable.appendChild(tr);
          raceRank++;
        });

        if(prevFirstRace && currentFirstRace !== prevFirstRace) {
          createFireworks();
          showFirstName(currentFirstRace);
          playCheer();
        }
        prevFirstRace = currentFirstRace;

        // ë¹„í–‰ê¸° ê¸°ë¡ (ì¤‘ë³µ í•™ë²ˆì€ ê°€ì¥ ë†’ì€ ì ìˆ˜ë§Œ ë‚¨ê¹€)
        const planeTable = document.getElementById('planeTable');
        planeTable.querySelectorAll('tr:not(:first-child)').forEach(row => row.remove());
        const planeRecords = {};
        data.filter(item => item.type === 'plane').forEach(item => {
          if (!planeRecords[item.studentId] || item.score > planeRecords[item.studentId].score) {
            planeRecords[item.studentId] = item;
          }
        });
        const planeSorted = Object.values(planeRecords).sort((a, b) => b.score - a.score);
        let planeRank = 1;
        let currentFirstPlane = null;
        planeSorted.forEach((item) => {
          if(planeRank === 1) currentFirstPlane = item.studentId;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${planeRank === 1 ? "ğŸ† " : ""}${planeRank}</td>
            <td>${item.studentId}</td>
            <td>${item.score}</td>
          `;
          planeTable.appendChild(tr);
          planeRank++;
        });

        if(prevFirstPlane && currentFirstPlane !== prevFirstPlane) {
          createFireworks();
          showFirstName(currentFirstPlane);
          playCheer();
        }
        prevFirstPlane = currentFirstPlane;

      } catch (e) {
        console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
      }
    }

    fetchAndRender();
    setInterval(fetchAndRender, 3000);
  </script>
</body>
</html>
