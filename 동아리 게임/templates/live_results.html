<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>레이스 실시간 순위</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; position: relative; margin:0; overflow:hidden; }
    table { border-collapse: collapse; width: 100%; max-width: 700px; margin-top: 20px; }
    th, td { border: 1px solid #999; padding: 8px; text-align: center; }
    th { background: #eee; }
    #particleCanvas { position:fixed; top:0; left:0; width: 100vw; pointer-events: none; z-index: 10; }
  </style>
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div style="display: flex; gap: 40px; align-items: flex-start;">
    <div style="flex:1;">
      <h2>자동차 레이스 순위</h2>
      <table id="raceTable">
        <tr>
          <th>순위</th>
          <th>학번</th>
          <th>Lap 1 (초)</th>
          <th>Lap 2 (초)</th>
          <th>Lap 3 (초)</th>
          <th>총 시간 (초)</th>
        </tr>
      </table>
    </div>
    <div style="flex:1;">
      <h2>비행기 게임 점수</h2>
      <table id="planeTable">
        <tr>
          <th>순위</th>
          <th>학번</th>
          <th>점수</th>
        </tr>
      </table>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');

    // 캔버스를 화면 전체 픽셀 크기로 맞춤
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let particles = [];

    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `${r},${g},${b}`;
    }

    // 화면 전체 폭죽 생성
    function createFireworks() {
      const colors = ['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff'];
      for (let i=0; i<200; i++) {
        particles.push({
          x: Math.random()*canvas.width,
          y: Math.random()*canvas.height,
          vx: (Math.random()-0.5)*10,
          vy: (Math.random()-0.5)*10,
          alpha: 1,
          size: Math.random()*8 + 2,
          color: colors[Math.floor(Math.random()*colors.length)]
        });
      }
    }

    function updateParticles() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      particles = particles.filter(p => p.alpha > 0);
      particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.alpha -= 0.005; // 오래 지속
        ctx.fillStyle = `rgba(${hexToRgb(p.color)},${p.alpha})`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, 2*Math.PI);
        ctx.fill();
      });
      requestAnimationFrame(updateParticles);
    }
    updateParticles();

    let prevFirstRace = null;
    let prevFirstPlane = null;

    async function fetchAndRender() {
      try {
        const res = await fetch('/api/results');
        if (!res.ok) throw new Error("서버 응답 오류");
        const data = await res.json();

        // 자동차 기록
        const raceTable = document.getElementById('raceTable');
        raceTable.querySelectorAll('tr:not(:first-child)').forEach(row => row.remove());
        let raceRank = 1;
        let currentFirstRace = null;
        data.filter(item => item.type !== 'plane').forEach((item) => {
          if(raceRank === 1) currentFirstRace = item.studentId;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${raceRank === 1 ? "🏆 " : ""}${raceRank}</td>
            <td>${item.studentId}</td>
            <td>${item.lap1 ? item.lap1.toFixed(2) : '-'}</td>
            <td>${item.lap2 ? item.lap2.toFixed(2) : '-'}</td>
            <td>${item.lap3 ? item.lap3.toFixed(2) : '-'}</td>
            <td>${item.total ? item.total.toFixed(2) : '-'}</td>
          `;
          raceTable.appendChild(tr);
          raceRank++;
        });

        if(prevFirstRace && currentFirstRace !== prevFirstRace) {
          createFireworks();
        }
        prevFirstRace = currentFirstRace;

        // 비행기 기록
        const planeTable = document.getElementById('planeTable');
        planeTable.querySelectorAll('tr:not(:first-child)').forEach(row => row.remove());
        let planeRank = 1;
        let currentFirstPlane = null;
        data.filter(item => item.type === 'plane').forEach((item) => {
          if(planeRank === 1) currentFirstPlane = item.studentId;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${planeRank === 1 ? "🏆 " : ""}${planeRank}</td>
            <td>${item.studentId}</td>
            <td>${item.score}</td>
          `;
          planeTable.appendChild(tr);
          planeRank++;
        });

        if(prevFirstPlane && currentFirstPlane !== prevFirstPlane) {
          createFireworks();
        }
        prevFirstPlane = currentFirstPlane;

      } catch (e) {
        console.error("데이터 불러오기 실패:", e);
      }
    }

    fetchAndRender();
    setInterval(fetchAndRender, 3000);
  </script>
</body>
</html>
